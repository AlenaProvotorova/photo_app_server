#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º –Ω–∞ Railway
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è Railway –¥–µ–ø–ª–æ—è..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:"

required_vars=("NODE_ENV" "JWT_SECRET" "CLOUDINARY_CLOUD_NAME" "CLOUDINARY_API_KEY" "CLOUDINARY_API_SECRET")

for var in "${required_vars[@]}"; do
    if [ -z "${!var}" ]; then
        echo "‚ùå $var –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
    else
        echo "‚úÖ $var —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
    fi
done

# –ü—Ä–æ–≤–µ—Ä–∫–∞ DATABASE_URL
if [ -z "$DATABASE_URL" ]; then
    echo "‚ö†Ô∏è  DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ (Railway —É—Å—Ç–∞–Ω–æ–≤–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)"
else
    echo "‚úÖ DATABASE_URL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
fi

echo ""
echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ TypeScript –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
if npm run build; then
    echo "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏"
    exit 1
fi

echo ""
echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ health check..."

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ —Ñ–æ–Ω–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
npm run start:prod &
APP_PID=$!

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
sleep 10

# –ü—Ä–æ–≤–µ—Ä–∫–∞ health check
if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
    echo "‚úÖ Health check —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "‚ùå Health check –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
fi

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
kill $APP_PID 2>/dev/null

echo ""
echo "üìä –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è Railway:"
echo "1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ Railway Dashboard"
echo "2. –î–æ–±–∞–≤—å—Ç–µ PostgreSQL —Å–µ—Ä–≤–∏—Å –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç"
echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–µ–ø–ª–æ—è –≤ Railway Dashboard"
echo "4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π railway.json —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º timeout"

echo ""
echo "üöÄ –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é!"
